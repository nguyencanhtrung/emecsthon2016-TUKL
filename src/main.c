/*
 * main.c
 *
 *  Created on: Feb 5, 2016
 *      Author: trungnguyen
 */
#include <stdint.h>
#include <stdbool.h>
#include "em_device.h"
#include "em_chip.h"
#include "em_cmu.h"
#include "em_emu.h"
#include "bsp.h"
#include "bsp_trace.h"
#include "em_gpio.h"
#include "uart.h"
#include "pwm.h"
#include "gpio.h"

#define minX 1620
#define minY 1600
#define midX 2250
#define midY 2230
#define resolution 70

int flag=0;
volatile uint32_t msTicks; /* counts 1ms timeTicks */

void Delay(uint32_t dlyTicks);

/**************************************************************************//**
 * @brief SysTick_Handler
 * Interrupt Service Routine for system tick counter
 *****************************************************************************/
void SysTick_Handler(void)
{
  msTicks++;       /* increment counter necessary in Delay()*/
}

/**************************************************************************//**
 * @brief Delays number of msTick Systicks (typically 1 ms)
 * @param dlyTicks Number of ticks to delay
 *****************************************************************************/
void Delay(uint32_t dlyTicks)
{
  uint32_t curTicks;

  curTicks = msTicks;
  while ((msTicks - curTicks) < dlyTicks) ;
}

/**************************************************************************//**
 * @brief  Main function
 *****************************************************************************/
int main(void)
{
	CHIP_Init();                                   // This function addresses some chip errata and should be called at the start of every EFM32 application (need em_system.c)

	/* If first word of user data page is non-zero, enable eA Profiler trace */
	//BSP_TraceProfilerSetup();
	/* initalize clocks */
	CMU->CTRL |= (1 << 14);                         // Set HF clock divider to /2 to keep core frequency <32MHz
	CMU->OSCENCMD |= 0x4;                           // Enable XTAL Oscillator
	while(! (CMU->STATUS & 0x8) );                  // Wait for XTAL osc to stabilize
	CMU->CMD = 0x2;                                 // Select HF XTAL osc as system clock source. 48MHz XTAL, but we divided the system clock by 2, therefore our HF clock should be 24MHz


  /* Setup SysTick Timer for 1 msec interrupts  */
  if (SysTick_Config(CMU_ClockFreqGet(cmuClock_CORE) / 1000)) while (1) ;

  usart_init();
  usart_enable_rx_isr();

  /* Initialize LED driver */
  BSP_LedsInit();
  BSP_LedSet(0);
  BSP_LedClear(1);

  /* Initialize PWM */
  initPCM();
  pwmEnableISRX(); // PE2
  pwmEnableISRY(); // PD2
  //transEnableLedISR();

  uint32_t widthY, widthX, boundX, boundY;
  /* Initialize GPIO*/
 // gpioInit();
 // gpioEnableISR();
 // GPIO_PinModeSet(gpioPortE, 3, gpioModePushPull,0);
  //width2 = 1300;
  setWidthPCMX(midX);
  setWidthPCMY(midY);
  widthX = midX;
  widthY = midY;
  //int arrx[100] = {2180,2220,2259,2298,2337,2375,2412,2448,2484,2518,2550,2582,2611,2639,2665,2690,2712,2732,2750,2766,2779,2790,2799,2805,2809,2810,2809,2805,2799,2790,2779,2766,2750,2732,2712,2690,2665,2639,2611,2582,2550,2518,2484,2448,2412,2375,2337,2298,2259,2220,2180,2140,2101,2062,2023,1985,1948,1912,1876,1842,1810,1778,1749,1721,1695,1670,1648,1628,1610,1594,1581,1570,1561,1555,1551,1550,1551,1555,1561,1570,1581,1594,1610,1628,1648,1670,1695,1721,1749,1778,1810,1842,1876,1912,1948,1985,2023,2062,2101,2140};
  //int arry[100] = {2790,2789,2785,2779,2770,2759,2746,2730,2712,2692,2670,2645,2619,2591,2562,2530,2498,2464,2428,2392,2355,2317,2278,2239,2200,2160,2120,2081,2042,2003,1965,1928,1892,1856,1822,1790,1758,1729,1701,1675,1650,1628,1608,1590,1574,1561,1550,1541,1535,1531,1530,1531,1535,1541,1550,1561,1574,1590,1608,1628,1650,1675,1701,1729,1758,1790,1822,1856,1892,1928,1965,2003,2042,2081,2120,2160,2200,2239,2278,2317,2355,2392,2428,2464,2498,2530,2562,2591,2619,2645,2670,2692,2712,2730,2746,2759,2770,2779,2785,2789};
  //int arrx[50] = {2180,2259,2337,2412,2484,2550,2611,2665,2712,2750,2779,2799,2809,2809,2799,2779,2750,2712,2665,2611,2550,2484,2412,2337,2259,2180,2101,2023,1948,1876,1810,1749,1695,1648,1610,1581,1561,1551,1551,1561,1581,1610,1648,1695,1749,1810,1876,1948,2023,2101};
  //int arry[50] = {2790,2785,2770,2746,2712,2670,2619,2562,2498,2428,2355,2278,2200,2120,2042,1965,1892,1822,1758,1701,1650,1608,1574,1550,1535,1530,1535,1550,1574,1608,1650,1701,1758,1822,1892,1965,2042,2120,2200,2278,2355,2428,2498,2562,2619,2670,2712,2746,2770,2785};
  int arrx[100] ={2250,2278,2306,2334,2362,2389,2416,2442,2467,2491,2515,2537,2558,2578,2597,2614,2630,2644,2657,2668,2678,2686,2692,2696,2699,2700,2699,2696,2692,2686,2678,2668,2657,2644,2630,2614,2597,2578,2558,2537,2515,2491,2467,2442,2416,2389,2362,2334,2306,2278,2250,2222,2194,2166,2138,2111,2084,2058,2033,2009,1985,1963,1942,1922,1903,1886,1870,1856,1843,1832,1822,1814,1808,1804,1801,1800,1801,1804,1808,1814,1822,1832,1843,1856,1870,1886,1903,1922,1942,1963,1985,2009,2033,2058,2084,2111,2138,2166,2194,2222};
  int arry[100] = {2700,2699,2696,2692,2686,2678,2668,2657,2644,2630,2614,2597,2578,2558,2537,2515,2491,2467,2442,2416,2389,2362,2334,2306,2278,2250,2222,2194,2166,2138,2111,2084,2058,2033,2009,1985,1963,1942,1922,1903,1886,1870,1856,1843,1832,1822,1814,1808,1804,1801,1800,1801,1804,1808,1814,1822,1832,1843,1856,1870,1886,1903,1922,1942,1963,1985,2009,2033,2058,2084,2111,2138,2166,2194,2222,2250,2278,2306,2334,2362,2389,2416,2442,2467,2491,2515,2537,2558,2578,2597,2614,2630,2644,2657,2668,2678,2686,2692,2696,2699};
  //int arrx[100] = {2250,2264,2278,2292,2306,2320,2333,2346,2358,2371,2382,2393,2404,2414,2423,2432,2440,2447,2454,2459,2464,2468,2471,2473,2475,2475,2475,2473,2471,2468,2464,2459,2454,2447,2440,2432,2423,2414,2404,2393,2382,2371,2358,2346,2333,2320,2306,2292,2278,2264,2250,2236,2222,2208,2194,2180,2167,2154,2142,2129,2118,2107,2096,2086,2077,2068,2060,2053,2046,2041,2036,2032,2029,2027,2025,2025,2025,2027,2029,2032,2036,2041,2046,2053,2060,2068,2077,2086,2096,2107,2118,2129,2142,2154,2167,2180,2194,2208,2222,2236};
  //int arry[100] = {2300,2300,2298,2296,2293,2289,2284,2279,2272,2265,2257,2248,2239,2229,2218,2207,2196,2183,2171,2158,2145,2131,2117,2103,2089,2075,2061,2047,2033,2019,2005,1992,1979,1967,1954,1943,1932,1921,1911,1902,1893,1885,1878,1871,1866,1861,1857,1854,1852,1850,1850,1850,1852,1854,1857,1861,1866,1871,1878,1885,1893,1902,1911,1921,1932,1943,1954,1967,1979,1992,2005,2019,2033,2047,2061,2075,2089,2103,2117,2131,2145,2158,2171,2183,2196,2207,2218,2229,2239,2248,2257,2265,2272,2279,2284,2289,2293,2296,2298,2300};
  while (1)
  {
	switch(mode){
	case 0x02:   //  Self-balancing
		for(int j=0; j<100; j++){
			setWidthPCMX(arrx[j]);
			setWidthPCMY(arry[j]);
			Delay(20);
		}

		break;
	case 0x01:   // Interactive
		boundX = (uint32_t)(minX + (int)rx_data[0] * resolution);
		boundY = (uint32_t)(minY + (int)rx_data[1] * resolution);
		if(widthX > boundX)
			widthX -= 1;
		else if(widthX < boundX)
			widthX += 1;
		setWidthPCMX(widthX);
		if(widthY > boundY)
			widthY -= 1;
		else if(widthY < boundY)
			widthY += 1;
		setWidthPCMY(widthY);
		break;
	default:
	//	Delay(1);
		break;
	}
	Delay(1);
	}
  }




